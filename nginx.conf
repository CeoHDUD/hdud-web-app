server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # ============================
  # API — proxy explícito
  # ============================

  # Timeline (CORE)
  location /timeline {
    proxy_http_version 1.1;

    # >>> CRÍTICO: força Host do upstream para a API montar base corretamente
    proxy_set_header Host hdud-api:4000;

    # repassa token
    proxy_set_header Authorization $http_authorization;

    # headers padrão
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # (opcional, mas útil p/ debug)
    proxy_set_header X-Forwarded-Host $host;

    proxy_pass http://hdud-api:4000/timeline;
  }

  # API genérica (/api/*)
  location /api/ {
    proxy_http_version 1.1;

    # >>> CRÍTICO: mesmo ajuste aqui
    proxy_set_header Host hdud-api:4000;

    proxy_set_header Authorization $http_authorization;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header X-Forwarded-Host $host;

    proxy_pass http://hdud-api:4000/;
  }

  # ============================
  # SPA fallback (React Router)
  # ============================
  location / {
    try_files $uri $uri/ /index.html;
  }
}
